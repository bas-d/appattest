package attestation

import (
	"bytes"
	"encoding/hex"
	"encoding/json"
	"testing"
)

func TestAttestationVerification(t *testing.T) {
	t.Run("Testing attestation", func(t *testing.T) {
		aar := AuthenticatorAttestationResponse{}
		if err := json.Unmarshal([]byte(attestation), &aar); err != nil {
			t.Fatal(err)
		}

		pk, _, err := aar.Verify("35MFYY2JY5.co.chiff.attestation-test", keyID)
		if err != nil {
			t.Fatalf("Not valid: %+v", err)
		}
		decodedPk, err := hex.DecodeString(publicKey)
		if err != nil {
			t.Fatalf("Could not decode public key: %+s", publicKey)
		}
		if !bytes.Equal(pk, decodedPk) {
			t.Fatalf("Wrong Public key : %x", pk)
		}

	})
}

const publicKey = "042bc5badb424b7f24b4f70a9e7e6f54309d26800c16cf10edf78820109c64a429a603244d57c2ad7156a2213a47eb674910c630706a56d170ccb3758e80d58218"
const attestation = `{ 
	"attestationObject": "o2NmbXRvYXBwbGUtYXBwYXR0ZXN0Z2F0dFN0bXSiY3g1Y4JZAuowggLmMIICbaADAgECAgYBeIJ9-FwwCgYIKoZIzj0EAwIwTzEjMCEGA1UEAwwaQXBwbGUgQXBwIEF0dGVzdGF0aW9uIENBIDExEzARBgNVBAoMCkFwcGxlIEluYy4xEzARBgNVBAgMCkNhbGlmb3JuaWEwHhcNMjEwMzI5MDkzNjM2WhcNMjEwNDAxMDkzNjM2WjCBkTFJMEcGA1UEAwxAZGE3NTc0MGU2M2E2MDExN2RmZmY5Y2Q1ODVjNjU4YzI3ZWZhMDZkNTk2NWRmN2QxZjk1ODgyOTcxNjA5MzgwZTEaMBgGA1UECwwRQUFBIENlcnRpZmljYXRpb24xEzARBgNVBAoMCkFwcGxlIEluYy4xEzARBgNVBAgMCkNhbGlmb3JuaWEwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAAQrxbrbQkt_JLT3Cp5-b1QwnSaADBbPEO33iCAQnGSkKaYDJE1Xwq1xVqIhOkfrZ0kQxjBwalbRcMyzdY6A1YIYo4HxMIHuMAwGA1UdEwEB_wQCMAAwDgYDVR0PAQH_BAQDAgTwMH4GCSqGSIb3Y2QIBQRxMG-kAwIBCr-JMAMCAQG_iTEDAgEAv4kyAwIBAb-JMwMCAQG_iTQmBCQzNU1GWVkySlk1LmNvLmNoaWZmLmF0dGVzdGF0aW9uLXRlc3SlBgQEc2tzIL-JNgMCAQW_iTcDAgEAv4k5AwIBAL-JOgMCAQAwGQYJKoZIhvdjZAgHBAwwCr-KeAYEBDE0LjQwMwYJKoZIhvdjZAgCBCYwJKEiBCAV9dKcM4VWkRheTdCIa6oNP2KwYYTTwS4xIzN80COTKzAKBggqhkjOPQQDAgNnADBkAjAXcHpgFGmDig-qEYAqpzA4A-JVaNjM4R36_U76xBXT4vYUDXuWg_qy-zOK8L_3luoCME_sPTYh2A3oSXQ16BbBHnKKp65Z0jhsfP4Gf0D7GSjlkXM-pwwSKoEzjP3nJzSk1VkCRzCCAkMwggHIoAMCAQICEAm6xeG8QBrZ1FOVvDgaCFQwCgYIKoZIzj0EAwMwUjEmMCQGA1UEAwwdQXBwbGUgQXBwIEF0dGVzdGF0aW9uIFJvb3QgQ0ExEzARBgNVBAoMCkFwcGxlIEluYy4xEzARBgNVBAgMCkNhbGlmb3JuaWEwHhcNMjAwMzE4MTgzOTU1WhcNMzAwMzEzMDAwMDAwWjBPMSMwIQYDVQQDDBpBcHBsZSBBcHAgQXR0ZXN0YXRpb24gQ0EgMTETMBEGA1UECgwKQXBwbGUgSW5jLjETMBEGA1UECAwKQ2FsaWZvcm5pYTB2MBAGByqGSM49AgEGBSuBBAAiA2IABK5bN6B3TXmyNY9A59HyJibxwl_vF4At6rOCalmHT_jSrRUleJqiZgQZEki2PLlnBp6Y02O9XjcPv6COMp6Ac6mF53Ruo1mi9m8p2zKvRV4hFljVZ6-eJn6yYU3CGmbOmaNmMGQwEgYDVR0TAQH_BAgwBgEB_wIBADAfBgNVHSMEGDAWgBSskRBTM72-aEH_pwyp5frq5eWKoTAdBgNVHQ4EFgQUPuNdHAQZqcm0MfiEdNbh4Vdy45swDgYDVR0PAQH_BAQDAgEGMAoGCCqGSM49BAMDA2kAMGYCMQC7voiNc40FAs-8_WZtCVdQNbzWhyw_hDBJJint0fkU6HmZHJrota7406hUM_e2DQYCMQCrOO3QzIHtAKRSw7pE-ZNjZVP-zCl_LrTfn16-WkrKtplcS4IN-QQ4b3gHu1iUObdncmVjZWlwdFkOXDCABgkqhkiG9w0BBwKggDCAAgEBMQ8wDQYJYIZIAWUDBAIBBQAwgAYJKoZIhvcNAQcBoIAkgASCA-gxggQXMCwCAQICAQEEJDM1TUZZWTJKWTUuY28uY2hpZmYuYXR0ZXN0YXRpb24tdGVzdDCCAvQCAQMCAQEEggLqMIIC5jCCAm2gAwIBAgIGAXiCffhcMAoGCCqGSM49BAMCME8xIzAhBgNVBAMMGkFwcGxlIEFwcCBBdHRlc3RhdGlvbiBDQSAxMRMwEQYDVQQKDApBcHBsZSBJbmMuMRMwEQYDVQQIDApDYWxpZm9ybmlhMB4XDTIxMDMyOTA5MzYzNloXDTIxMDQwMTA5MzYzNlowgZExSTBHBgNVBAMMQGRhNzU3NDBlNjNhNjAxMTdkZmZmOWNkNTg1YzY1OGMyN2VmYTA2ZDU5NjVkZjdkMWY5NTg4Mjk3MTYwOTM4MGUxGjAYBgNVBAsMEUFBQSBDZXJ0aWZpY2F0aW9uMRMwEQYDVQQKDApBcHBsZSBJbmMuMRMwEQYDVQQIDApDYWxpZm9ybmlhMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEK8W620JLfyS09wqefm9UMJ0mgAwWzxDt94ggEJxkpCmmAyRNV8KtcVaiITpH62dJEMYwcGpW0XDMs3WOgNWCGKOB8TCB7jAMBgNVHRMBAf8EAjAAMA4GA1UdDwEB_wQEAwIE8DB-BgkqhkiG92NkCAUEcTBvpAMCAQq_iTADAgEBv4kxAwIBAL-JMgMCAQG_iTMDAgEBv4k0JgQkMzVNRllZMkpZNS5jby5jaGlmZi5hdHRlc3RhdGlvbi10ZXN0pQYEBHNrcyC_iTYDAgEFv4k3AwIBAL-JOQMCAQC_iToDAgEAMBkGCSqGSIb3Y2QIBwQMMAq_ingGBAQxNC40MDMGCSqGSIb3Y2QIAgQmMCShIgQgFfXSnDOFVpEYXk3QiGuqDT9isGGE08EuMSMzfNAjkyswCgYIKoZIzj0EAwIDZwAwZAIwF3B6YBRpg4oPqhGAKqcwOAPiVWjYzOEd-v1O-sQV0-L2FA17loP6svszivC_95bqAjBP7D02IdgN6El0NegWwR5yiqeuWdI4bHz-Bn9A-xko5ZFzPqcMEiqBM4z95yc0pNUwKAIBBAIBAQQgbG3abZRG07LuZLR4wUxIg7H22oyjis-IcYLJBltJo6IwYAIBBQIBAQRYdWx2TGdQY0QyOVgrR2trbXRRbklFZVdvelZGMFNtaXNHMFprYzZXY01Fc09YYURJNG1CTjJ5SWtNRytXUDZyUDhrYStFbXhkOUJKeGRROUowSGpOdVE9PTAOAgEGAgEBBAZBVFRFU1QwDwIBBwIBAQQHc2FuZGJveDAgAgEMAgEBBBgyMDIxLTAzBDMtMzBUMDk6MzY6MzYuOTY5WjAgAgEVAgEBBBgyMDIxLTA2LTI4VDA5OjM2OjM2Ljk2OVoAAAAAAACggDCCA60wggNUoAMCAQICEFkzVq3lWYLPREI3rN9FG1MwCgYIKoZIzj0EAwIwfDEwMC4GA1UEAwwnQXBwbGUgQXBwbGljYXRpb24gSW50ZWdyYXRpb24gQ0EgNSAtIEcxMSYwJAYDVQQLDB1BcHBsZSBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTETMBEGA1UECgwKQXBwbGUgSW5jLjELMAkGA1UEBhMCVVMwHhcNMjAwNTE5MTc0NzMxWhcNMjEwNjE4MTc0NzMxWjBaMTYwNAYDVQQDDC1BcHBsaWNhdGlvbiBBdHRlc3RhdGlvbiBGcmF1ZCBSZWNlaXB0IFNpZ25pbmcxEzARBgNVBAoMCkFwcGxlIEluYy4xCzAJBgNVBAYTAlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEf-kVNGzDinuYPJPR0ENf2KvaVnAE0yxYhmVRlXq0ePfLKvi6Rff6eOrGLEnk-c3AhLUDFPECM9qbdvpEKiu4cqOCAdgwggHUMAwGA1UdEwEB_wQCMAAwHwYDVR0jBBgwFoAU2Rf-S2eQOEuS9NvO1VeAFAuPPckwQwYIKwYBBQUHAQEENzA1MDMGCCsGAQUFBzABhidodHRwOi8vb2NzcC5hcHBsZS5jb20vb2NzcDAzLWFhaWNhNWcxMDEwggEcBgNVHSAEggETMIIBDzCCAQsGCSqGSIb3Y2QFATCB_TCBwwYIKwYBBQUHAgIwgbYMgbNSZWxpYW5jZSBvbiB0aGlzIGNlcnRpZmljYXRlIGJ5IGFueSBwYXJ0eSBhc3N1bWVzIGFjY2VwdGFuY2Ugb2YgdGhlIHRoZW4gYXBwbGljYWJsZSBzdGFuZGFyZCB0ZXJtcyBhbmQgY29uZGl0aW9ucyBvZiB1c2UsIGNlcnRpZmljYXRlIHBvbGljeSBhbmQgY2VydGlmaWNhdGlvbiBwcmFjdGljZSBzdGF0ZW1lbnRzLjA1BggrBgEFBQcCARYpaHR0cDovL3d3dy5hcHBsZS5jb20vY2VydGlmaWNhdGVhdXRob3JpdHkwHQYDVR0OBBYEFGkexw9H7OON3XU3RPPp4VpsEFYlMA4GA1UdDwEB_wQEAwIHgDAPBgkqhkiG92NkDA8EAgUAMAoGCCqGSM49BAMCA0cAMEQCICUYFlxeKZxZ9oU5rV3bmfY3PvYOzQhFqf13GtYkLSwiAiBdKpsqX6ujY4FljRhA969IC9droZTYNCCH9NaTW7UbrjCCAvkwggJ_oAMCAQICEFb7g9Qr_43DN5kjtVqubr0wCgYIKoZIzj0EAwMwZzEbMBkGA1UEAwwSQXBwbGUgUm9vdCBDQSAtIEczMSYwJAYDVQQLDB1BcHBsZSBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTETMBEGA1UECgwKQXBwbGUgSW5jLjELMAkGA1UEBhMCVVMwHhcNMTkwMzIyMTc1MzMzWhcNMzQwMzIyMDAwMDAwWjB8MTAwLgYDVQQDDCdBcHBsZSBBcHBsaWNhdGlvbiBJbnRlZ3JhdGlvbiBDQSA1IC0gRzExJjAkBgNVBAsMHUFwcGxlIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MRMwEQYDVQQKDApBcHBsZSBJbmMuMQswCQYDVQQGEwJVUzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABJLOY719hrGrKAo7HOGv-wSUgJGs9jHfpssoNW9ES-Eh5VfdEo2NuoJ8lb5J-r4zyq7NBBnxL0Ml-vS-s8uDfrqjgfcwgfQwDwYDVR0TAQH_BAUwAwEB_zAfBgNVHSMEGDAWgBS7sN6hWDOImqSKmd6-veuv2sskqzBGBggrBgEFBQcBAQQ6MDgwNgYIKwYBBQUHMAGGKmh0dHA6Ly9vY3NwLmFwcGxlLmNvbS9vY3NwMDMtYXBwbGVyb290Y2FnMzA3BgNVHR8EMDAuMCygKqAohiZodHRwOi8vY3JsLmFwcGxlLmNvbS9hcHBsZXJvb3RjYWczLmNybDAdBgNVHQ4EFgQU2Rf-S2eQOEuS9NvO1VeAFAuPPckwDgYDVR0PAQH_BAQDAgEGMBAGCiqGSIb3Y2QGAgMEAgUAMAoGCCqGSM49BAMDA2gAMGUCMQCNb6afoeDk7FtOc4qSfz14U5iP9NofWB7DdUr-OKhMKoMaGqoNpmRt4bmT6NFVTO0CMGc7LLTh6DcHd8vV7HaoGjpVOz81asjF5pKw4WG-gElp5F8rqWzhEQKqzGHZOLdzSjCCAkMwggHJoAMCAQICCC3F_IjSxUuVMAoGCCqGSM49BAMDMGcxGzAZBgNVBAMMEkFwcGxlIFJvb3QgQ0EgLSBHMzEmMCQGA1UECwwdQXBwbGUgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkxEzARBgNVBAoMCkFwcGxlIEluYy4xCzAJBgNVBAYTAlVTMB4XDTE0MDQzMDE4MTkwNloXDTM5MDQzMDE4MTkwNlowZzEbMBkGA1UEAwwSQXBwbGUgUm9vdCBDQSAtIEczMSYwJAYDVQQLDB1BcHBsZSBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eTETMBEGA1UECgwKQXBwbGUgSW5jLjELMAkGA1UEBhMCVVMwdjAQBgcqhkjOPQIBBgUrgQQAIgNiAASY6S89QHKk7ZMicoETHN0QlfHFo05x3BQW2Q7lpgUqd2R7X04407scRLV_9R-2MmJdyemEW08wTxFaAP1YWAyl9Q8sTQdHE3Xal5eXbzFc7SudeyA72LlU2V6ZpDpRCjGjQjBAMB0GA1UdDgQWBBS7sN6hWDOImqSKmd6-veuv2sskqzAPBgNVHRMBAf8EBTADAQH_MA4GA1UdDwEB_wQEAwIBBjAKBggqhkjOPQQDAwNoADBlAjEAg-nBxBZeGl00GNnt7_RsDgBGS7jfskYRxQ_95nqMoaZrzsID1Jz1k8Z0uGrfqiMVAjBtZooQytQN1E_NjUM-tIpjpTNu423aF7dkH8hTJvmIYnQ5Cxdby1GoDOgYA-eisigAADGB_TCB-gIBATCBkDB8MTAwLgYDVQQDDCdBcHBsZSBBcHBsaWNhdGlvbiBJbnRlZ3JhdGlvbiBDQSA1IC0gRzExJjAkBgNVBAsMHUFwcGxlIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MRMwEQYDVQQKDApBcHBsZSBJbmMuMQswCQYDVQQGEwJVUwIQWTNWreVZgs9EQjes30UbUzANBglghkgBZQMEAgEFADAKBggqhkjOPQQDAgRHMEUCIQCf2YLK-0BE1ENxUEbBoPB7WmAgUiUOOx1vHkRt-DStEQIgfFlisqd9xIh0ihWoElb1XlItVC33D-_ppd_fiiXo0LMAAAAAAABoYXV0aERhdGFYpHzvK1XackEIupEnlvZ1_wC-cdUtriaPpojTTKbSf3B0QAAAAABhcHBhdHRlc3RkZXZlbG9wACDadXQOY6YBF9__nNWFxljCfvoG1ZZd99H5WIKXFgk4DqUBAgMmIAEhWCArxbrbQkt_JLT3Cp5-b1QwnSaADBbPEO33iCAQnGSkKSJYIKYDJE1Xwq1xVqIhOkfrZ0kQxjBwalbRcMyzdY6A1YIY",
	"clientData": "YXR0ZXN0YXRpb24tdGVzdA" 
}`
const keyID = "2nV0DmOmARff/5zVhcZYwn76BtWWXffR+ViClxYJOA4="
